オブジェクト指向おみくじ「objectiveOmikuji」
==

- おみくじプログラムを、私の持てる技術の全てを費やしてオブジェクト指向で書いてみました。その解説を記載しています。
- オブジェクト指向でコードを書くときは、現実に当てはめてオブジェクトを作る派とそうでない派がいて、そうでない派の方が多いのですが、今回はどっちかというとそうである派のノリで作りました。ただあまり細かいことは考えずにノリで実装してます。一応、オブジェクト指向の真髄である「保守・拡張しやすいコード」を心がけるようにはしました。
- ほぼ全てのクラスにmainメソッドがありますが、各クラスのテスト用に書いているだけで、おみくじを取得して結果をおみくじらしく表示するという、本来の意味のmainメソッドはまだ実装していません。テストは本来はmainメソッドでなくちゃんとテストコードを書くべきなんですが、ちょっとめんどくさくてまだ書いてないです・・・
- おみくじの記載内容がおみくじごとに異なることを知らなかったので、一度生成したおみくじをコピーする実装になっています。誰か興味ある方、おみくじごとに記載が変わるように実装してみてください・・・

## OmikujiData.yaml
- おみくじの原稿をyamlで記述します。
- トップのディレクティブが運勢で、その中に運勢の詳細を記載します。
  - 例えば`rate`は、その運勢の出現確率です。
- 「なんとかun」は、好きなだけ書き加えてOKです。
- contentsも、後述のOmikujiWriterがランダムで選ぶので好きなだけ書いてOKです。

## OmikujiPropertiesFromYaml.py
- OmikujiData.yamlを読み込んで、おみくじデータを辞書型にして返すクラスです。
- 業務であれば、ここでyamlのフォーマットのバリデーションを行うべきです。面倒なのでやってませんが・・・

## OmikujiProperties.py
- 見ての通り、OmikujiPropertiesFromYaml.pyを継承しているだけのクラスで、おみくじデータの利用者（後述のOmikujiWriterなど）からおみくじデータの取得元を隠蔽するためのラッパークラスです。
- 今はyamlだけですが、おみくじデータの取得元はデータベースやRESTなどに今後変わるかもしれません。仮に変わったとしてもおみくじデータの利用者にとっては、おみくじデータが辞書型で取得できれば手段はなんでもよく、むしろ手段ごとに取得元のクラスが分かれていると利用者側のコードの書換えの手間が出てきます。
- 取得手段を実装したクラスをこのクラスで継承して渡すことで、クラス利用者側の変更の手間を減らすのが目的です。
> このクラスに全ての取得手段を書くのもありですが、コード量が増えてくるとメンテが大変になるので分けて書くほうがいいと思います。

- 辞書を取得するメソッド（今回だと`get_omikuji_raw_data()`)は、どの取得手段のクラスでも同じ名前＆引数で実装するのが望ましいです。そうすることで、利用者側は`get_omikuji_raw_data()`を呼び出すだけで、あらゆる取得手段を利用することができます。いわゆるポリモーフィズムの実装で、pythonではダックタイピングと呼ばれる手法です。ちなみにJavaであればインターフェースを使ってメソッドの実装を強要できますが、pythonは標準でインターフェースを持ってないので、メソッド名や引数を同じにするかは実装者の良心に委ねられることになります。
- 今回の場合は、OmikujiPropertiesをインスタンス化するのは後述のOmikujiFactoryだけなので、実はこのクラスはあんまり意味なかったりしますｗ

## Omikuji.py
- おみくじオブジェクトのクラスです。
- 本来であれば、unseiとかkinunとかいうプロパティを持つべきですが、実装時点で持っていません。これらのプロパティは、後述のOmikujiWriterがおみくじデータを解析して動的に設定するようにしてます。これは、おみくじの項目を変えたいときにyamlの変更だけで済むようにしたかったという意図ゆえです。
> 業務の場合は、クラス図が書きにくくなるのでこういう設計はしたらダメだと思います。今回は単にsetattr関数を使ってみたかっただけです。

- おみくじの出現確率を取得する`get_rate()`メソッドと、自分のプロパティを返す`get_vars()`メソッドだけ実装しています。まだ存在しないプロパティを利用するメソッドが書けるなんて、なかなか興味深いです。

## OmikujiWriter.py
- OmikujiPropertiesから取得したおみくじデータを元におみくじオブジェクトを作成してリストに格納し、それを返却するクラスです。
- おみくじオブジェクトは、OmikujiData.yamlのトップのディレクティブの数だけ作成されます。ディレクティブが5種類の場合（運勢が5種類の場合）、5個のおみくじオブジェクトが作成されリストに格納されます。
> おみくじの中身はおみくじごとに変わるので、ここの実装はそのうち変えたい（誰か変えて〜）

- OmikujiPropertiesを利用するにも関わらず、クラス内でインスタンス化せず、`main()`メソッドからコンストラクタに渡しています。クラス内でインスタンス化すると、OmikujiPropertiesの実装が終わるまで（動くようになるまで）OmikujiWriterのテストができません。モック（後述）を作って対応することはできますが、本来のクラスと同名のモックを書くわけにはいかないし、テストのときだけ書き換えるの面倒とか、いろいろ問題が起きてきます。
- これを解決するために、インスタンス化をクラス内で行うのではなく、クラス外でインスタンス化されたものを渡すという手法を取ります。これにより、OmikujiPropertiesと同じプロパティを持つ適当なインスタンスを自分で作成してOmikujiWriterに渡すことができるので、テストも実装も柔軟に対応できます。
> 例えばget_omikuji_raw_data()メソッドが呼ばれたら辞書型の適当なおみくじデータを返すだけの簡単なクラスを書いて、インスタンス化して渡すだけの簡単な作業です。こういった、本来のクラスの動作を模擬するクラスのことをモック(mock)クラスと呼びます。

- インスタンスをクラスの外から渡す手法をDI（Dependency Injection：依存性の注入）と呼び、チーム開発やフレームワークを利用する際に必須となる技術です。例えばJavaのwebフレームワークであるSpringはDIをするためのものだし、webフロントエンドフレームワークのangularでは、クラスの結合は全てDIで行います。
> ちなみにDIを日本語で「依存性の注入」と呼ぶのは誤訳じゃないかとよく言われていて、「オブジェクトの注入」と考えたほうが理解しやすいです。

## OmikujiBox.py
- 大量のおみくじオブジェクトを格納し、ランダムでおみくじオブジェクトを1個返却してくれるクラスです。
- おみくじオブジェクトを格納するためのset_omikuji()メソッドを実装してます。が、おみくじを格納するのはおみくじ箱が能動的にやることじゃないだろ・・・と思い、Javaプログラマの間でよく話題になるセッターゲッター不要論てこういうことなのか。。。などと考えつつも、考えるのがめんどくさくなってそのまま実装しましたｗ

## OmikujiFactory.py
- OmikujiPropertiesからおみくじデータを取得し、それを元にOmikujiWriterにおみくじを書かせ、Omikujiオブジェクトを複製してOmikujiBoxを作成するクラスです。各オブジェクトはここでインスタンス化せずに、全てDIしてます。
- おみくじを書く人を雇っておみくじを書かせ、それをおみくじ箱に詰める工場みたいなイメージなのでFactoryと名付けていますが、デザインパターンのFactoryパターンとは特に関係ありませんのであしからず・・・
- Omikujiオブジェクトの持つ`get_rate()`メソッドを使って運勢ごとの出現確率を取得し、出現確率を踏まえながらおみくじを複製しています。

## main.py
- OmikujiFactoryを利用するメインルーチンで、5個のおみくじを出力します。見ての通りかなりやっつけ仕事ですｗ
- OmikujiFactoryに必要な各オブジェクトをインスタンス化してDIしてます。このmain.pyが、各クラスの利用者であり、各クラスとそのメソッドやメンバーは、利用者の利便性を考えて実装されるべきだというのがオブジェクト指向の考え方です。例えば、OmikujiBoxに`get_omikuji()`するとOmikujiオブジェクトが得られ、そのオブジェクトの`get_vars()`を使うとおみくじの内容が得られるというのは、人間の自然な思考に則っていて、コードが書きやすくなってるのが実感できると思います。え？できませんか？そうですか。。。

### 今後
- 肝心のおみくじを表示するコードを実装してないので、誰か気が向いたらお願いしますｗ
- OmikujiFactoryにおみくじ箱を発注するjinjaクラスとか、そのjinjaクラスを利用しておみくじを引くsanpaishaクラスとかを使うメソッドをmain.pyに実装してもおもしろいかも知れません。
