オブジェクト指向おみくじ「objectiveOmikuji」
==

- おみくじプログラムを、私の持てる技術の全てを費やしてオブジェクト指向で書いてみました。その解説を記載しています。
- 動かしてみたい場合は、以下の手順で。
  - リポジトリをclone
  - feature/objectiveOmikujiをチェックアウト
  - objectiveOmikujiディレクトリに移動
  - `python3 main.py`で実行
  > おみくじが5個、生の辞書のまま出てくるだけなので別に面白くないですｗ

## コードについて
- オブジェクト指向の説明をするとき、何もかも現実に当てはめて説明する資料が多く、それらはよく混乱の元になっているようなのですが（動物クラスを継承した犬クラスに鳴けメソッドを実装するとかなんとか）、今回はどっちかというと現実に当てはめるノリで作りました。ただあまり細かいことは考えずにノリで実装してます。一応、オブジェクト指向の真髄である「保守・拡張しやすいコード」を心がけるようにはしました。
- ほぼ全てのクラスにmainメソッドがありますが、各クラスのテスト用に書いているだけで、おみくじを取得して結果をおみくじらしく表示するという、本来の意味のmainメソッドはまだ実装していません。テストは本来はmainメソッドでなくちゃんとテストコードを書くべきなんですが、ちょっとめんどくさくてまだ書いてないです・・・
- おみくじの記載内容がおみくじごとに異なることを知らなかったので、一度生成したおみくじをコピーする実装になっています。誰か興味ある方、おみくじごとに記載が変わるように実装してみてください。

## コード解説
### OmikujiData.yaml
- おみくじの原稿をyamlで記述します。
- トップのディレクティブが運勢で、その中に運勢の詳細を記載します。
  - 例えば`rate`は、その運勢の出現確率です。
- 「なんとかun」は、好きなだけ書き加えてOKです。
- contentsも、後述のOmikujiWriterがランダムで選ぶので好きなだけ書いてOKです。

### OmikujiPropertiesFromYaml.py
- OmikujiData.yamlを読み込んで、おみくじデータを辞書型にして返すクラスです。
- 業務であれば、ここでyamlのフォーマットのバリデーションを行うべきです。面倒なのでやってませんが・・・

### OmikujiProperties.py
- 見ての通り、OmikujiPropertiesFromYaml.pyを継承しているだけのクラスで、おみくじデータの利用者（後述のOmikujiWriterなど）からおみくじデータの取得元を隠蔽するためのラッパークラスです。
- 今はyamlだけですが、おみくじデータの取得元はデータベースやRESTなどに今後変わるかもしれません。仮に変わったとしてもおみくじデータの利用者にとっては、おみくじデータが辞書型で取得できれば手段はなんでもよく、むしろ手段ごとに取得元のクラスが分かれていると利用者側のコードの書換えの手間が出てきます。
- 取得手段を実装したクラスをこのクラスで継承して渡すことで、クラス利用者側の変更の手間を減らすのが目的です。
> このクラスに全ての取得手段を書くのもありですが、コード量が増えてくるとメンテが大変になるので分けて書くほうがいいと思います。

- 辞書を取得するメソッド（今回だと`get_omikuji_raw_data()`)は、どの取得手段のクラスでも同じ名前＆引数で実装するのが望ましいです。そうすることで、利用者側は`get_omikuji_raw_data()`を呼び出すだけで、あらゆる取得手段を利用することができます。いわゆるポリモーフィズムの実装で、pythonではダックタイピングと呼ばれる手法です。Javaであればインターフェースを使ってメソッドの実装を強要できますが、pythonは標準でインターフェースを持ってないので、メソッド名や引数を同じにするかは実装者の良心に委ねられることになります。
- 今回の場合は、OmikujiPropertiesをインスタンス化するのは後述のOmikujiFactoryだけなので、実はこのクラスはあんまり意味なかったりしますｗ

### Omikuji.py
- おみくじオブジェクトのクラスです。
- 本来であれば、unseiとかkinunとかいうプロパティを持つべきですが、実装時点で持っていません。これらのプロパティは、後述のOmikujiWriterがおみくじデータを解析して動的に設定するようにしてます。これは、おみくじの項目を変えたいときにyamlの変更だけで済むようにしたかったという意図ゆえです。
> 業務の場合は、クラス図が書きにくくなるのでこういう設計はしたらダメだと思います。今回は単にsetattr関数を使ってみたかっただけです。

- おみくじの出現確率を取得する`get_rate()`メソッドと、自分のプロパティを返す`get_vars()`メソッドだけ実装しています。今の時点でrateプロパティが無いにも関わらずコードを書けるのはおもしろいですが、OmikujiData.yamlのrateを書き換えたときにどうするんだとかそういうことは考えてませんｗ

### OmikujiWriter.py
- OmikujiPropertiesから取得したおみくじデータを元におみくじオブジェクトを作成してリストに格納し、それを返却するクラスです。
- おみくじオブジェクトは、OmikujiData.yamlのトップのディレクティブの数だけ作成されます。ディレクティブが5種類の場合（運勢が5種類の場合）、5個のおみくじオブジェクトが作成されリストに格納されます。
> おみくじの中身はおみくじごとに変わるので、ここの実装はそのうち変えたい（誰か変えて〜）

- OmikujiPropertiesを利用するにも関わらず、クラス内でインスタンス化せず、`main()`メソッドからコンストラクタに渡しています。クラス内でインスタンス化すると、OmikujiPropertiesの実装が終わるまで（動くようになるまで）OmikujiWriterのテストや実装ができません。そういう場合はモックと呼ばれる、本来のオブジェクトと同じ動作をする簡易的な模造オブジェクトを作って対応することはできますが、同じ名前のモックは作れないのでコードを書き換えないといけないし、テスト対象のクラスにうまく差し込む（patchと呼ぶ）ようにするとか、いろいろ問題が起きてきます。
- これを解決するために、インスタンス化をクラス内で行うのではなく、クラス外でインスタンス化されたものを渡すという手法を取ります。これにより、OmikujiPropertiesと同じプロパティを持つ適当なインスタンスを自分で作成してOmikujiWriterに渡すことができるので、テストも実装も柔軟に対応できます。
> 例えばget_omikuji_raw_data()メソッドが呼ばれたら辞書型の適当なおみくじデータを返すだけの簡単なクラスを書いて、インスタンス化して渡すことになります。

- インスタンスをクラスの外から渡す手法をDI（Dependency Injection：依存性の注入）と呼び、チーム開発やフレームワークを利用する際に必須となる技術です。例えばJavaのwebフレームワークであるSpringはDIをするためのものだし、webフロントエンドフレームワークのangularでは、クラスの結合は全てDIで行います。
> ちなみにDIを日本語で「依存性の注入」と呼ぶのは誤訳じゃないかとよく言われていて、「オブジェクトの注入」と考えたほうが理解しやすいです。

- で、ここまで書いておいてなんですが、Omikujiオブジェクトは思いっきりクラス内でインスタンス化してますｗ。おみくじはおみくじを書く人が作るもんだろ・・・という意図と、運勢の数だけOmikujiオブジェクトが出来上がるので、その度に新しいオブジェクトを使用する必要がある、という考えで敢えてこうしてます。もちろんDIしてもいいんですが、このクラスをテストするときにOmikujiオブジェクトのメソッド（`get_rate()`とか）は使わないので、モックを作るのは大した手間じゃないないな・・・とか適当な考えでこういう実装にしました。

### OmikujiBox.py
- 大量のおみくじオブジェクトを格納し、ランダムでおみくじオブジェクトを1個返却してくれるクラスです。
- おみくじオブジェクトを格納するためのset_omikuji()メソッドを実装してます。が、おみくじを格納するのはおみくじ箱が能動的にやることじゃないだろ・・・と思い、Javaプログラマの間でよく話題になるセッターゲッター不要論てこういうことなのか。。。などと考えつつも、考えるのがめんどくさくなってそのまま実装しましたｗ

### OmikujiFactory.py
- OmikujiPropertiesからおみくじデータを取得し、それを元にOmikujiWriterにおみくじを書かせ、Omikujiオブジェクトを複製してOmikujiBoxを作成するクラスです。各オブジェクトはここでインスタンス化せずに、全てDIしてます。
- おみくじを書く人を雇っておみくじを書かせ、それをおみくじ箱に詰める工場みたいなイメージなのでFactoryと名付けていますが、デザインパターンのFactoryパターンとは特に関係ありませんのであしからず・・・
- Omikujiオブジェクトの持つ`get_rate()`メソッドを使って運勢ごとの出現確率を取得し、出現確率を踏まえながらおみくじを複製しています。

### main.py
- OmikujiFactoryを利用するメインルーチンで、5個のおみくじを出力します。見ての通りかなりやっつけ仕事ですｗ
- OmikujiFactoryに必要な各オブジェクトをインスタンス化してDIしてます。このmain.pyが、各クラスの利用者であり、各クラスとそのメソッドやメンバーは、利用者の利便性を考えて実装されるべきだというのがオブジェクト指向の考え方です。例えば、OmikujiBoxに`get_omikuji()`するとOmikujiオブジェクトが得られ、そのオブジェクトの`get_vars()`を使うとおみくじの内容が得られるというのは、人間の自然な思考に則っていて、コードが書きやすくなってるのが実感できると思います。え？できませんか？そうですか。。。

## 今後
- おみくじを引いて、きれいに整形して表示するという肝心なコードを実装してないので、誰か気が向いたらお願いします。
- OmikujiFactoryにおみくじ箱を発注するjinjaクラスとか、そのjinjaクラスを利用しておみくじを引くsanpaishaクラスなどを実装してmain.pyから利用してもおもしろいかも知れません。
